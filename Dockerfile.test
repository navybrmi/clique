# Dockerfile for testing build locally before pushing to Vercel
# This simulates Vercel's build environment

FROM node:20-slim

# Install OpenSSL for Prisma
RUN apt-get update -y && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy package files and prisma schema first
COPY package*.json ./
COPY prisma ./prisma

# Install dependencies (clean install like Vercel does)
RUN npm ci

# Copy all source files
COPY . .

# Run Prisma generate (happens in postinstall but explicit here)
RUN npx prisma generate

# Run tests with coverage checks (must pass before build)
RUN npm run test:coverage

# Run integration tests
RUN npm run test:integration

# Run the build command (same as Vercel)
RUN npm run build:docker

# Verify the build was successful
RUN test -d .next

# Default command to show success
CMD ["echo", "âœ… Build successful! This would deploy to Vercel."]
