// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  recommendations Recommendation[]
  comments      Comment[]
  upvotes       UpVote[]
}

// NextAuth.js models
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// Category model
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entities       Entity[]
  communityTags  CommunityTag[]

  @@index([name])
}

// Entity model - represents a specific item being recommended
model Entity {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  categoryId String
  category   Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  recommendations Recommendation[]
  restaurant      Restaurant?   @relation(name: "EntityRestaurant")
  movie           Movie?        @relation(name: "EntityMovie")
  fashion         Fashion?      @relation(name: "EntityFashion")
  household       Household?    @relation(name: "EntityHousehold")
  other           Other?        @relation(name: "EntityOther")

  @@index([name])
  @@index([categoryId])
}

// Recommendation model - common fields only
model Recommendation {
  id        String   @id @default(cuid())
  tags      String[] @default([])  // Array of recommendation reasons
  link      String?
  imageUrl  String?
  rating    Int?     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  entityId   String
  entity     Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  comments Comment[]
  upvotes  UpVote[]

  @@index([userId])
  @@index([entityId])
  @@index([createdAt])
}

// Restaurant model
model Restaurant {
  entityId      String   @unique
  entity        Entity   @relation(name: "EntityRestaurant", fields: [entityId], references: [id], onDelete: Cascade)
  cuisine       String?
  location      String?
  priceRange    String?
  hours         String?
  phoneNumber   String?
  placeId       String?  // Google Places ID or similar
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([placeId])
  @@index([location])
}

// Movie model
model Movie {
  entityId  String   @unique
  entity    Entity   @relation(name: "EntityMovie", fields: [entityId], references: [id], onDelete: Cascade)
  director  String?
  year      Int?
  genre     String?
  duration  String?
  attributes String[] @default([])
  tmdbId    String?  // TheMovieDB ID
  imdbId    String?  // IMDB ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tmdbId])
  @@index([imdbId])
}

// Fashion model
model Fashion {
  entityId  String   @unique
  entity    Entity   @relation(name: "EntityFashion", fields: [entityId], references: [id], onDelete: Cascade)
  brand     String?
  price     String?
  size      String?
  color     String?
  season    String?
  material  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Household model
model Household {
  entityId      String   @unique
  entity        Entity   @relation(name: "EntityHousehold", fields: [entityId], references: [id], onDelete: Cascade)
  productType   String?
  model         String?
  purchaseLink  String?
  warranty      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Other model (for flexible category)
model Other {
  entityId      String   @unique
  entity        Entity   @relation(name: "EntityOther", fields: [entityId], references: [id], onDelete: Cascade)
  customFields  Json?    // Flexible JSON for custom properties
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// CommunityTag model - tracks user-created tags that may be promoted to precanned
model CommunityTag {
  id         String   @id @default(cuid())
  tag        String   // The actual tag text, stored in original case (e.g., "Great cinematography")
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  usageCount Int      @default(1)  // Track how many recommendations use this tag
  isPromoted Boolean  @default(false)  // True when it graduates to precanned
  createdAt  DateTime @default(now())

  @@unique([tag, categoryId])
  @@index([categoryId])
  @@index([usageCount])
  @@index([isPromoted])
}

// Comment model
model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendationId String
  recommendation   Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recommendationId])
}

// UpVote model
model UpVote {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId           String
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendationId String
  recommendation   Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@unique([userId, recommendationId])
  @@index([userId])
  @@index([recommendationId])
}
